name: Analyzer Pipeline

on:
  push:
    branches: [ main, pr-7 ]
    paths:
      - 'analyzer/**'
      - 'scripts/run_analysis.py'
      - 'scripts/scoding.py'
      - 'tests/analyzer/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'analyzer/**'
      - 'scripts/run_analysis.py'
      - 'scripts/scoding.py'
      - 'tests/analyzer/**'

jobs:
  analyzer-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest
    
    - name: Run analysis demo
      run: |
        python scripts/run_analysis.py --demo
    
    - name: Run scoring
      run: |
        python scripts/scoding.py
    
    - name: Run tests
      run: |
        pytest -q tests/analyzer/
    
    - name: Check for engine errors
      run: |
        if grep -q "__engine_error__" public/data/contradictions.json; then
          echo "Engine errors detected in output"
          exit 1
        else
          echo "No engine errors found"
        fi
    
    - name: Upload analysis artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: analyzer-output
        path: |
          public/data/contradictions.json
          public/data/contradictions_scored.json
          public/data/contradictions_scored.csv
          public/data/statements_debug.json
          public/data/run_meta.json